- name: Ensure hosts can login with Password A (fallback Password B then change to A)
  hosts: all
  gather_facts: false

  vars:
    # ส่งเข้ามาจาก AWX extra_vars หรือ vault
    pass_a: "{{ pass_a }}"   # REQUIRED
    pass_b: "{{ pass_b }}"   # REQUIRED

  tasks:
    - name: Try SSH with Pass A
      ping:
      vars:
        ansible_user: "{{ ansible_user }}"
        ansible_password: "{{ pass_a }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      register: ping_a
      ignore_errors: true
      ignore_unreachable: true

    - name: Mark pass_a_ok
      set_fact:
        pass_a_ok: "{{ (ping_a.ping | default('')) == 'pong' }}"

    - name: Try SSH with Pass B (only if Pass A failed)
      when: not pass_a_ok
      ping:
      vars:
        ansible_user: "{{ ansible_user }}"
        ansible_password: "{{ pass_b }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      register: ping_b
      ignore_errors: true
      ignore_unreachable: true

    - name: Mark pass_b_ok
      when: not pass_a_ok
      set_fact:
        pass_b_ok: "{{ (ping_b.ping | default('')) == 'pong' }}"

    # เปลี่ยน password จาก B -> A (ทำบน controller/runner)
    - name: Change password from B to A via interactive passwd (only if Pass B works)
      when: (not pass_a_ok) and (pass_b_ok | default(false))
      delegate_to: localhost
      expect:
        command: >-
          bash -lc '
          if ! command -v sshpass >/dev/null 2>&1; then
            echo "sshpass not found on controller"; exit 2;
          fi
          sshpass -p "{{ pass_b }}" ssh
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          -o PreferredAuthentications=password
          -o PubkeyAuthentication=no
          {{ ansible_user }}@{{ inventory_hostname }} "passwd"
          '
        responses:
          '(?i)(current|old).*password:': "{{ pass_b }}"
          '(?i)new.*password:': "{{ pass_a }}"
          '(?i)(retype|repeat).*new.*password:': "{{ pass_a }}"
        timeout: 180
      register: chpass

    - name: Reset connection and verify Pass A again
      when: (not pass_a_ok) and (pass_b_ok | default(false))
      block:
        - meta: reset_connection

        - name: Verify SSH with Pass A after change
          ping:
          vars:
            ansible_user: "{{ ansible_user }}"
            ansible_password: "{{ pass_a }}"
            ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          register: ping_a2
          ignore_errors: true
          ignore_unreachable: true

        - set_fact:
            pass_a_ok: "{{ (ping_a2.ping | default('')) == 'pong' }}"

    - name: Final status per host
      debug:
        msg:
          - "pass_a_ok={{ pass_a_ok | default(false) }}"
          - "pass_b_ok={{ pass_b_ok | default(false) }}"
          - "result={{ 'OK (Pass A)' if (pass_a_ok|default(false)) else ('CHANGED B->A' if (pass_b_ok|default(false)) else 'FAIL') }}"
