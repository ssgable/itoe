- name: Ensure hosts can login with Password A (fallback Password B then change)
  hosts: all
  gather_facts: false

  vars:
    login_user: "{{ ansible_user }}"
    pass_a: "{{ pass_a }}"
    pass_b: "{{ pass_b }}"

  tasks:
    # -------------------------------
    # Try PASS A
    # -------------------------------
    - name: Try SSH with Pass A
      ping:
      vars:
        ansible_password: "{{ pass_a }}"
      register: ping_a
      ignore_errors: true
      ignore_unreachable: true

    - name: Set fact pass_a_ok
      set_fact:
        pass_a_ok: "{{ ping_a.ping | default('') == 'pong' }}"

    # -------------------------------
    # Try PASS B
    # -------------------------------
    - name: Try SSH with Pass B
      when: not pass_a_ok
      ping:
      vars:
        ansible_password: "{{ pass_b }}"
      register: ping_b
      ignore_errors: true
      ignore_unreachable: true

    - name: Set fact pass_b_ok
      when: not pass_a_ok
      set_fact:
        pass_b_ok: "{{ ping_b.ping | default('') == 'pong' }}"

    # -------------------------------
    # Change password B -> A
    # -------------------------------
    - name: Change password from B to A
      when: (not pass_a_ok) and (pass_b_ok | default(false))
      delegate_to: localhost
      expect:
        command: >
          sshpass -p "{{ pass_b }}" ssh
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          {{ login_user }}@{{ inventory_hostname }} passwd
        responses:
          '(?i)(current|old).*password:': "{{ pass_b }}"
          '(?i)new.*password:': "{{ pass_a }}"
          '(?i)(retype|repeat).*new.*password:': "{{ pass_a }}"
        timeout: 180

    - name: Reset connection
      when: (not pass_a_ok) and (pass_b_ok | default(false))
      meta: reset_connection

    # -------------------------------
    # Verify PASS A again
    # -------------------------------
    - name: Verify SSH with Pass A
      when: not pass_a_ok
      ping:
      vars:
        ansible_password: "{{ pass_a }}"
      register: ping_final
      ignore_errors: true
      ignore_unreachable: true

    - name: Final result
      debug:
        msg:
          - "Host={{ inventory_hostname }}"
          - "PASS_A_OK={{ (ping_final.ping | default(ping_a.ping|default(''))) == 'pong' }}"
          - "RESULT={{ 'OK' if (ping_final.ping|default('')) == 'pong' else 'FAIL' }}"
