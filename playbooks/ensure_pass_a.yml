---
############################################################
# PLAY 1: Load Hosts from ipdc.txt
############################################################
- name: Load target hosts from ipdc.txt
  hosts: localhost
  gather_facts: no

  vars:
    ip_file_path: "{{ playbook_dir }}/../inventories/ipdc.txt"

  tasks:

    - name: Validate ipdc.txt exists
      stat:
        path: "{{ ip_file_path }}"
      register: ip_file_check

    - name: Fail if ipdc.txt missing
      fail:
        msg: "ipdc.txt not found at {{ ip_file_path }}"
      when: not ip_file_check.stat.exists

    - name: Read ipdc.txt
      set_fact:
        ip_list: "{{ lookup('file', ip_file_path).splitlines()
                     | reject('equalto','')
                     | list }}"

    - name: Add hosts dynamically
      add_host:
        name: "{{ item }}"
        groups: dynamic_targets
      loop: "{{ ip_list }}"


############################################################
# PLAY 2: Password Migration Logic
############################################################
- name: Enterprise Password Migration
  hosts: dynamic_targets
  gather_facts: no
  become: yes
  serial: 50   # ควบคุม concurrency (สำคัญมากสำหรับ 1500 VM)

  vars:
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    report_path: "/runner/artifacts/ssh_password_migration_report.csv"

  tasks:

    - name: Validate required variables
      assert:
        that:
          - pass_a is defined
          - pass_b is defined
          - ansible_user is defined
        fail_msg: "Missing required vars (pass_a, pass_b, ansible_user)"

    ########################################################
    # Try Password A
    ########################################################
    - name: Try SSH with Pass A
      ping:
      vars:
        ansible_password: "{{ pass_a }}"
      register: ping_a
      ignore_errors: yes
      ignore_unreachable: yes

    - name: Set pass_a_ok
      set_fact:
        pass_a_ok: "{{ ping_a.ping is defined and ping_a.ping == 'pong' }}"

    ########################################################
    # Try Password B (fallback)
    ########################################################
    - name: Try SSH with Pass B
      when: not pass_a_ok
      ping:
      vars:
        ansible_password: "{{ pass_b }}"
      register: ping_b
      ignore_errors: yes
      ignore_unreachable: yes

    - name: Set pass_b_ok
      when: not pass_a_ok
      set_fact:
        pass_b_ok: "{{ ping_b.ping is defined and ping_b.ping == 'pong' }}"

    ########################################################
    # Change Password if needed
    ########################################################
    - name: Change password to Pass A
      when:
        - not pass_a_ok
        - pass_b_ok | default(false)
      user:
        name: "{{ ansible_user }}"
        password: "{{ pass_a | password_hash('sha512') }}"
      vars:
        ansible_password: "{{ pass_b }}"

    ########################################################
    # Collect Result for Report
    ########################################################
    - name: Build result line
      set_fact:
        report_line: >-
          {{ inventory_hostname }},
          {{ pass_a_ok | default(false) }},
          {{ pass_b_ok | default(false) }}

    - name: Append to report (local)
      delegate_to: localhost
      lineinfile:
        path: "{{ report_path }}"
        line: "{{ report_line }}"
        create: yes
